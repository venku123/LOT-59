<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lot 59 â€” Property Purchase Tracker</title>
<style>
  :root {
    --bg: #0D0D0F; --bg2: #131316; --bg3: #1A1A1F;
    --border: #1E1E24; --border2: #2A2A30;
    --gold: #E8C547; --gold2: #F0A500;
    --teal: #4ECDC4; --red: #FF6B6B; --green: #A8D870;
    --text: #F0EDE8; --text2: #C0BDB8; --muted: #888; --dim: #555;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: Georgia, serif; min-height: 100vh; }
  input, textarea, select { font-family: inherit; }

  .header { background: linear-gradient(135deg,#1A1A1F,#0D0D0F); border-bottom:1px solid var(--border); padding:1.8rem 2rem 1.4rem; }
  .header-inner { max-width:960px; margin:0 auto; }
  .header-top { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:1rem; }
  .header-tag { font-size:.65rem; letter-spacing:.22em; color:var(--gold); text-transform:uppercase; margin-bottom:.4rem; }
  .header-title { font-size:1.45rem; font-weight:normal; }
  .header-sub { font-size:.82rem; color:var(--muted); margin-top:.3rem; }
  .header-price-label { font-size:.65rem; letter-spacing:.15em; color:var(--muted); text-transform:uppercase; }
  .header-price { font-size:1.9rem; color:var(--gold); font-weight:bold; }
  .prog-labels { display:flex; justify-content:space-between; margin-bottom:.4rem; font-size:.72rem; }
  .prog-track { height:6px; background:#1E1E24; border-radius:3px; overflow:hidden; }
  .prog-fill { height:100%; background:linear-gradient(90deg,var(--gold),var(--gold2)); border-radius:3px; transition:width .5s; }

  .tabs { border-bottom:1px solid var(--border); background:var(--bg); position:sticky; top:0; z-index:50; }
  .tabs-inner { max-width:960px; margin:0 auto; display:flex; overflow-x:auto; }
  .tab-btn { padding:.95rem 1.2rem; background:none; border:none; color:var(--dim); border-bottom:2px solid transparent; cursor:pointer; font-size:.78rem; letter-spacing:.05em; white-space:nowrap; transition:color .2s; font-family:inherit; }
  .tab-btn.active { color:var(--gold); border-bottom-color:var(--gold); }

  .content { max-width:960px; margin:0 auto; padding:2rem; }

  .card { background:var(--bg2); border:1px solid var(--border); border-radius:8px; }
  .card-hdr { padding:.75rem 1.2rem; background:var(--bg3); border-bottom:1px solid var(--border); }
  .card-hdr-lbl { font-size:.7rem; letter-spacing:.16em; color:var(--gold); text-transform:uppercase; }
  .card-row { padding:.75rem 1.2rem; border-bottom:1px solid var(--bg); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem; }
  .card-row:last-child { border-bottom:none; }
  .card-total { padding:.85rem 1.2rem; display:flex; justify-content:space-between; align-items:center; }

  .grid-sum { display:grid; grid-template-columns:repeat(auto-fit,minmax(155px,1fr)); gap:.9rem; margin-bottom:1.5rem; }
  .sum-card { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1.1rem; }
  .sum-lbl { font-size:.65rem; color:var(--dim); letter-spacing:.12em; text-transform:uppercase; margin-bottom:.45rem; }
  .sum-val { font-size:1.2rem; font-weight:bold; }
  .sum-sub { font-size:.72rem; color:var(--dim); margin-top:.2rem; }

  .stage-item { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1.1rem 1.2rem; margin-bottom:.7rem; transition:all .2s; }
  .stage-item.paid { background:#0F1A18; border-color:#1E3B36; }
  .stage-top { display:flex; align-items:flex-start; gap:.9rem; }
  .stage-icon { font-size:1.4rem; flex-shrink:0; margin-top:.1rem; }
  .stage-body { flex:1; }
  .stage-title-row { display:flex; justify-content:space-between; flex-wrap:wrap; gap:.5rem; align-items:flex-start; }
  .stage-name { font-size:.92rem; font-weight:bold; }
  .stage-name.paid { color:var(--teal); }
  .stage-desc { font-size:.73rem; color:var(--dim); margin-top:.15rem; }
  .badge { display:inline-block; margin-left:.4rem; font-size:.62rem; padding:.1rem .38rem; border-radius:3px; font-weight:bold; }
  .badge-paid { color:var(--teal); background:#0F2E2A; }
  .badge-done { color:var(--green); background:#1A2E0F; }
  .stage-ctrls { display:flex; gap:.7rem; flex-wrap:wrap; align-items:center; margin-top:.7rem; }
  .stage-note { margin-top:.5rem; width:100%; background:var(--bg); border:1px solid var(--border); color:var(--muted); border-radius:4px; padding:.38rem .6rem; font-size:.76rem; }
  .stage-note:focus { outline:none; border-color:var(--gold); }

  /* VARIATIONS - CATALOGUE */
  .var-tabs { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1rem; }
  .var-tab { padding:.4rem .9rem; border-radius:20px; border:1px solid var(--border2); background:var(--bg2); color:var(--muted); cursor:pointer; font-size:.75rem; font-family:inherit; transition:all .2s; }
  .var-tab.active { background:var(--gold); color:#000; border-color:var(--gold); font-weight:bold; }

  .catalogue-item { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:.9rem 1.1rem; margin-bottom:.6rem; transition:all .2s; }
  .catalogue-item.selected { background:#0F1A0F; border-color:#2A4A2A; }
  .catalogue-item.pending-sel { background:#1A1600; border-color:#3A3200; }
  .cat-top { display:flex; align-items:flex-start; gap:.8rem; }
  .cat-check { margin-top:.25rem; width:17px; height:17px; cursor:pointer; flex-shrink:0; accent-color:var(--green); }
  .cat-info { flex:1; }
  .cat-name { font-size:.87rem; color:var(--text); line-height:1.4; }
  .cat-note { font-size:.71rem; color:var(--dim); margin-top:.2rem; line-height:1.4; }
  .cat-right { text-align:right; flex-shrink:0; }
  .cat-price { font-size:.95rem; font-weight:bold; color:var(--gold); }
  .cat-price.selected { color:var(--green); }
  .cat-status { font-size:.68rem; margin-top:.25rem; }

  /* MY VARIATIONS list */
  .myvar-item { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1rem 1.2rem; margin-bottom:.7rem; }
  .myvar-item.included { background:#0F1A0F; border-color:#2A4A2A; }
  .myvar-item.pending { background:#1A1600; border-color:#3A3200; }
  .myvar-item.excluded { opacity:.5; }
  .myvar-top { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; flex-wrap:wrap; }
  .myvar-left { flex:1; }
  .myvar-cat { font-size:.68rem; color:var(--gold); letter-spacing:.1em; text-transform:uppercase; margin-bottom:.2rem; }
  .myvar-name { font-size:.9rem; color:var(--text); }
  .myvar-note { font-size:.72rem; color:var(--dim); margin-top:.2rem; }
  .myvar-right { text-align:right; }
  .myvar-amt { font-size:1rem; font-weight:bold; color:var(--gold); }
  .myvar-status-lbl { font-size:.7rem; font-weight:bold; margin-top:.2rem; }

  /* TIMELINE */
  .tl-wrap { position:relative; }
  .tl-line { position:absolute; left:19px; top:0; bottom:0; width:2px; background:var(--border); }
  .ms-item { display:flex; gap:1.1rem; align-items:flex-start; position:relative; z-index:1; margin-bottom:.6rem; }
  .ms-dot { width:38px; height:38px; border-radius:50%; border:2px solid var(--border2); background:var(--bg2); display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; transition:all .2s; font-size:.78rem; color:var(--dim); }
  .ms-dot.done { background:var(--gold); border-color:var(--gold); color:#000; font-weight:bold; }
  .ms-card { flex:1; background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:.75rem 1rem; }
  .ms-card.done { background:#131A0F; border-color:#2A3A1E; }
  .ms-lbl { font-size:.88rem; }
  .ms-lbl.done { color:var(--green); }
  .ms-row { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem; }

  /* NOTES */
  .note-card { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1.1rem; margin-bottom:.7rem; }
  .note-date { font-size:.68rem; color:var(--dim); margin-bottom:.5rem; }
  .note-text { color:var(--text2); font-size:.87rem; line-height:1.65; white-space:pre-wrap; }

  /* PAY PROGRESS */
  .pay-prog { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1.1rem; margin-bottom:1.3rem; }
  .pay-bar-track { height:8px; background:#1E1E24; border-radius:4px; overflow:hidden; margin-top:.7rem; }
  .pay-bar-fill { height:100%; background:linear-gradient(90deg,var(--teal),var(--gold)); border-radius:4px; transition:width .5s; }

  /* VAR SUMMARY */
  .var-sum { background:var(--bg2); border:1px solid var(--border); border-radius:8px; padding:1.1rem 1.4rem; margin-bottom:1.3rem; }
  .var-sum-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:.8rem; margin-top:.8rem; }
  .vsub-lbl { font-size:.68rem; color:var(--dim); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.3rem; }
  .vsub-val { font-size:1.1rem; font-weight:bold; }

  /* ADD CUSTOM FORM */
  .add-form { background:var(--bg2); border:1px solid var(--border2); border-radius:8px; padding:1.2rem; margin-bottom:1rem; }
  .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:.8rem; margin-bottom:.8rem; }
  .form-field label { display:block; font-size:.7rem; color:var(--muted); margin-bottom:.3rem; letter-spacing:.08em; text-transform:uppercase; }
  .form-field input, .form-field select { width:100%; background:var(--bg); border:1px solid var(--border2); color:var(--text); border-radius:4px; padding:.35rem .5rem; font-size:.82rem; }
  .form-field input:focus, .form-field select:focus { outline:none; border-color:var(--gold); }

  /* INPUTS */
  input[type=text], input[type=number], textarea { background:var(--bg); border:1px solid var(--border2); color:var(--text); border-radius:4px; padding:.3rem .5rem; font-size:.82rem; }
  input[type=text]:focus, input[type=number]:focus, textarea:focus { outline:none; border-color:var(--gold); }
  input[type=date] { background:var(--bg); border:1px solid var(--border2); color:var(--muted); border-radius:4px; padding:.25rem .45rem; font-size:.73rem; font-family:inherit; }
  input[type=date]:focus { outline:none; border-color:var(--gold); }
  input[type=checkbox] { cursor:pointer; accent-color:var(--teal); }
  select { background:var(--bg); border:1px solid var(--border2); color:var(--text); border-radius:4px; padding:.3rem .5rem; font-size:.8rem; font-family:inherit; }
  select:focus { outline:none; border-color:var(--gold); }

  .btn { border:none; border-radius:6px; padding:.5rem 1rem; cursor:pointer; font-size:.8rem; font-family:inherit; font-weight:bold; transition:opacity .2s; }
  .btn:hover { opacity:.85; }
  .btn-gold { background:var(--gold); color:#000; }
  .btn-ghost { background:var(--border); color:var(--muted); }
  .btn-sm { padding:.3rem .7rem; font-size:.74rem; }
  .btn-red { background:transparent; color:var(--red); border:1px solid var(--red); }

  .promo-banner { background:linear-gradient(135deg,#1A1800,#131316); border:1px solid #3A3000; border-radius:8px; padding:1.1rem 1.4rem; display:flex; align-items:center; gap:1rem; }
  .grand-total { background:linear-gradient(135deg,#1A1800,#131316); border:1px solid #3A3000; border-radius:8px; padding:1.1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; }
  .sec-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.3rem; flex-wrap:wrap; gap:.5rem; }
  .sec-title { font-size:.95rem; font-weight:normal; color:var(--muted); }
  .empty-state { text-align:center; padding:3rem; color:var(--dim); }
  .save-ind { position:fixed; bottom:1.2rem; right:1.5rem; background:var(--bg3); border:1px solid var(--border2); border-radius:6px; padding:.4rem .8rem; font-size:.72rem; color:var(--dim); opacity:0; transition:opacity .4s; pointer-events:none; }
  .save-ind.show { opacity:1; }
  .search-box { width:100%; background:var(--bg); border:1px solid var(--border2); color:var(--text); border-radius:6px; padding:.5rem .8rem; font-size:.83rem; margin-bottom:.9rem; }
  .search-box:focus { outline:none; border-color:var(--gold); }
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }
  @media(max-width:600px) {
    .header { padding:1.2rem; }
    .content { padding:1rem; }
    .form-grid { grid-template-columns:1fr; }
    .header-price { font-size:1.4rem; }
  }
</style>
</head>
<body>

<div class="save-ind" id="saveInd">âœ“ Saved</div>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-top">
      <div>
        <div class="header-tag">Property Purchase Tracker</div>
        <div class="header-title">Lot 59 Zhang Street, Holmview QLD</div>
        <div class="header-sub">Somerfield West &nbsp;Â·&nbsp; Transpire Constructions &nbsp;Â·&nbsp; Custom 155 â€“ Broughton Facade &nbsp;Â·&nbsp; 4 Bed Â· 2 Bath Â· 1 Garage</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div class="header-price-label">Turn-Key Price</div>
        <div class="header-price">$845,700</div>
      </div>
    </div>
    <div style="margin-top:1.4rem;">
      <div class="prog-labels">
        <span style="color:var(--muted)">Journey Progress</span>
        <span style="color:var(--gold)" id="progLabel">0% milestones complete</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
    </div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tabs-inner">
    <button class="tab-btn active" onclick="switchTab('overview',this)">â—ˆ Overview</button>
    <button class="tab-btn" onclick="switchTab('payments',this)">ğŸ’³ Payments</button>
    <button class="tab-btn" onclick="switchTab('variations',this)">ğŸ”§ Variations</button>
    <button class="tab-btn" onclick="switchTab('timeline',this)">ğŸ“… Timeline</button>
    <button class="tab-btn" onclick="switchTab('costs',this)">ğŸ§¾ All Costs</button>
    <button class="tab-btn" onclick="switchTab('notes',this)">âœï¸ Notes</button>
  </div>
</div>

<div class="content">

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="grid-sum" id="sumCards"></div>
    <div class="card" style="margin-bottom:1rem;">
      <div class="card-hdr"><span class="card-hdr-lbl">Property Details</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem;padding:1.2rem;">
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Builder</div><div style="font-size:.85rem;color:var(--text2)">Transpire Constructions (QBCC 1310329)</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Design</div><div style="font-size:.85rem;color:var(--text2)">Custom 155 â€“ Broughton Facade</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Land Area</div><div style="font-size:.85rem;color:var(--text2)">394mÂ²</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">House Area</div><div style="font-size:.85rem;color:var(--text2)">155mÂ²</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Land Price</div><div style="font-size:.85rem;color:var(--text2)">$465,000</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Build Price</div><div style="font-size:.85rem;color:var(--text2)">$380,700</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Estate</div><div style="font-size:.85rem;color:var(--text2)">Somerfield West, Logan City</div></div>
        <div><div style="font-size:.68rem;color:var(--dim);margin-bottom:.2rem;">Variation Sheet</div><div style="font-size:.85rem;color:var(--text2)">QLD Standard v6/02/2025</div></div>
      </div>
    </div>
    <div class="promo-banner">
      <span style="font-size:1.5rem;">â­</span>
      <div>
        <div style="color:var(--gold);font-size:.85rem;font-weight:bold;">Transpire Upgrade Pack â€” $7,140 Value (No Extra Charge)</div>
        <div style="color:var(--muted);font-size:.76rem;margin-top:.25rem;">900mm Gas Cooktop Â· Semi-Frameless Screens Â· Pendant Lights Â· Handleless Cabinetry Â· Waterfall Benchtop Â· Double Undermount Sink Â· Soft-Close Drawers Â· Cold Water Fridge Point Â· Polished Mirrors</div>
      </div>
    </div>
  </div>

  <!-- PAYMENTS -->
  <div id="tab-payments" style="display:none">
    <div class="sec-row">
      <div class="sec-title">Construction Progress Payments</div>
      <span style="font-size:.8rem;color:var(--gold)" id="stageCount"></span>
    </div>
    <div class="pay-prog">
      <div style="display:flex;justify-content:space-between;font-size:.76rem;">
        <span style="color:var(--muted)">Paid: <span id="payPaid" style="color:var(--teal)">$0</span></span>
        <span style="color:var(--dim)">Remaining: <span id="payRem">$0</span></span>
      </div>
      <div class="pay-bar-track"><div class="pay-bar-fill" id="payBar" style="width:0%"></div></div>
    </div>
    <div id="stagesList"></div>
    <div class="card" style="margin-top:1rem;">
      <div class="card-total">
        <span style="color:var(--muted);font-size:.85rem;">Total Payment Schedule</span>
        <span style="color:var(--gold);font-size:1.1rem;font-weight:bold;" id="stageTot">$0</span>
      </div>
    </div>
  </div>

  <!-- VARIATIONS -->
  <div id="tab-variations" style="display:none">
    <!-- Summary -->
    <div class="var-sum">
      <div style="font-size:.7rem;letter-spacing:.15em;color:var(--gold);text-transform:uppercase;">Variation Summary</div>
      <div class="var-sum-grid">
        <div><div class="vsub-lbl">Confirmed Total</div><div class="vsub-val" style="color:var(--green)" id="vIncTot">$0</div></div>
        <div><div class="vsub-lbl">Pending Total</div><div class="vsub-val" style="color:var(--gold)" id="vPendTot">$0</div></div>
        <div><div class="vsub-lbl">Excluded</div><div class="vsub-val" style="color:var(--dim)" id="vExcTot">$0</div></div>
        <div><div class="vsub-lbl">Contract + Confirmed</div><div class="vsub-val" style="color:var(--gold2)" id="vContractImpact">$845,700</div></div>
      </div>
    </div>

    <!-- Sub tabs -->
    <div class="var-tabs">
      <button class="var-tab active" id="vtab-catalogue" onclick="setVarTab('catalogue')">ğŸ“‹ Transpire Catalogue</button>
      <button class="var-tab" id="vtab-mylist" onclick="setVarTab('mylist')">âœ… My Variations</button>
      <button class="var-tab" id="vtab-custom" onclick="setVarTab('custom')">â• Add Custom</button>
    </div>

    <!-- CATALOGUE -->
    <div id="vsub-catalogue">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:.8rem;">Browse and tick items from the Transpire QLD Standard Variation Pricing Sheet. Ticked items appear in <strong>My Variations</strong>.</div>
      <input class="search-box" type="text" placeholder="ğŸ”  Search variations..." oninput="filterCatalogue(this.value)">
      <div class="var-tabs" id="catFilterTabs" style="margin-bottom:.9rem;"></div>
      <div id="catalogueList"></div>
    </div>

    <!-- MY VARIATIONS list -->
    <div id="vsub-mylist" style="display:none">
      <div id="myVarList"></div>
    </div>

    <!-- ADD CUSTOM -->
    <div id="vsub-custom" style="display:none">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem;">Add any variation not in the catalogue â€” e.g. builder negotiated items, site-specific costs, or items you've confirmed verbally.</div>
      <div class="add-form">
        <div style="font-size:.78rem;color:var(--gold);letter-spacing:.1em;text-transform:uppercase;margin-bottom:.8rem;" id="customFormTitle">New Custom Variation</div>
        <div class="form-grid">
          <div class="form-field" style="grid-column:1/-1">
            <label>Description *</label>
            <input type="text" id="cName" placeholder="e.g. 2700mm ceiling height upgrade">
          </div>
          <div class="form-field">
            <label>Category</label>
            <select id="cCat">
              <option>Structural</option><option>Ceiling Height</option><option>Roofing</option>
              <option>Windows & Doors</option><option>Entrance Door</option><option>Garage Door</option>
              <option>Wardrobe Doors</option><option>Shelving</option><option>Cabinetry</option>
              <option>Benchtops</option><option>Tiling Walls</option><option>Shower Screens</option>
              <option>Mirrors</option><option>Plumbing Hardware</option><option>Appliances</option>
              <option>Hot Water System</option><option>Electrical â€“ Lighting</option>
              <option>Electrical â€“ Fans</option><option>Electrical â€“ Power</option>
              <option>Electrical â€“ Other</option><option>Timber Flooring</option><option>Carpet</option>
              <option>Floor Tiles</option><option>Air Conditioning</option><option>Screens</option>
              <option>Window Coverings</option><option>Driveway & Path</option><option>Alfresco</option>
              <option>Promo Upgrade</option><option>Other</option>
            </select>
          </div>
          <div class="form-field">
            <label>Amount ($) *</label>
            <input type="number" id="cAmount" placeholder="0" min="0">
          </div>
          <div class="form-field">
            <label>Status</label>
            <select id="cStatus">
              <option value="pending">â³ Pending Decision</option>
              <option value="included">âœ“ Confirmed / Included</option>
              <option value="excluded">âœ— Excluded / Declined</option>
            </select>
          </div>
          <div class="form-field">
            <label>Date</label>
            <input type="date" id="cDate">
          </div>
          <div class="form-field" style="grid-column:1/-1">
            <label>Notes</label>
            <input type="text" id="cNote" placeholder="e.g. confirmed with builder on phone, single storey rate applies">
          </div>
        </div>
        <div style="display:flex;gap:.6rem;">
          <button class="btn btn-gold btn-sm" onclick="saveCustom()">Save</button>
          <button class="btn btn-ghost btn-sm" onclick="clearCustomForm()">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TIMELINE -->
  <div id="tab-timeline" style="display:none">
    <div class="sec-row">
      <div class="sec-title">Purchase & Construction Milestones</div>
      <span style="font-size:.8rem;color:var(--gold)" id="msCount"></span>
    </div>
    <div class="tl-wrap">
      <div class="tl-line"></div>
      <div id="msList"></div>
    </div>
  </div>

  <!-- ALL COSTS -->
  <div id="tab-costs" style="display:none">
    <div class="sec-title" style="margin-bottom:1.3rem;">Complete Cost Breakdown</div>
    <div class="card" style="margin-bottom:1rem;">
      <div class="card-hdr"><span class="card-hdr-lbl">Base Contract</span></div>
      <div class="card-row"><span style="color:var(--text2);font-size:.87rem;">Land Price</span><span>$465,000</span></div>
      <div class="card-row"><span style="color:var(--text2);font-size:.87rem;">Build Contract (Custom 155)</span><span>$380,700</span></div>
      <div class="card-total"><span style="color:var(--gold);font-size:.9rem;">Turn-Key Subtotal</span><span style="color:var(--gold);font-weight:bold;">$845,700</span></div>
    </div>
    <div class="card" style="margin-bottom:1rem;">
      <div class="card-hdr"><span class="card-hdr-lbl">Confirmed Variations</span></div>
      <div id="costsVarRows"></div>
      <div class="card-total"><span style="color:var(--muted);font-size:.87rem;">Variations Subtotal</span><span style="color:var(--text);font-weight:bold;" id="costsVarTot">$0</span></div>
    </div>
    <div class="card" style="margin-bottom:1rem;">
      <div class="card-hdr"><span class="card-hdr-lbl">Additional / Oncosts (Editable Estimates)</span></div>
      <div id="oncostRows"></div>
      <div class="card-total"><span style="color:var(--muted);font-size:.87rem;">Oncosts Subtotal</span><span style="color:var(--text);font-weight:bold;" id="oncostTot">$0</span></div>
    </div>
    <div class="grand-total">
      <div>
        <div style="font-size:.7rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;">Estimated Grand Total</div>
        <div style="font-size:.7rem;color:var(--dim);margin-top:.2rem;">incl. confirmed variations & all oncosts</div>
      </div>
      <div style="font-size:1.65rem;color:var(--gold);font-weight:bold;" id="grandTot">$845,700</div>
    </div>
  </div>

  <!-- NOTES -->
  <div id="tab-notes" style="display:none">
    <div class="sec-row">
      <div class="sec-title">Notes & Records</div>
      <button class="btn btn-gold btn-sm" onclick="openNote()">+ Add Note</button>
    </div>
    <div id="addNoteWrap" style="display:none;margin-bottom:1rem;" class="add-form">
      <textarea id="noteText" rows="4" placeholder="Write your note... (builder calls, decisions, inspection results, concerns)" style="width:100%;resize:vertical;background:var(--bg);border:1px solid var(--border2);color:var(--text);border-radius:4px;padding:.6rem;font-size:.85rem;"></textarea>
      <div style="margin-top:.7rem;display:flex;gap:.6rem;">
        <button class="btn btn-gold btn-sm" onclick="saveNote()">Save</button>
        <button class="btn btn-ghost btn-sm" onclick="closeNote()">Cancel</button>
      </div>
    </div>
    <div id="notesList"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSPIRE CATALOGUE â€” full variation pricing sheet
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATALOGUE = [
  // STRUCTURAL
  { id:'s1', cat:'Structural', name:'Increased floor area (per mÂ² â€” not wet areas)', price:1265, note:'$1,265/mÂ² single storey | $1,485/mÂ² double storey' },
  { id:'s2', cat:'Structural', name:'E Class slab design in lieu of standard H Class', price:9500, note:'Per job up to 220mÂ² slab design' },
  { id:'s3', cat:'Structural', name:'Corefilled blockwork retaining wall (per mÂ² â€” wall < 3100mm high)', price:1506, note:'Includes design, footings, waterproofing, gravel, agg drain, labour' },
  { id:'s4', cat:'Structural', name:'House on stumps in lieu of H Class waffle pod slab (per mÂ²)', price:367, note:'Max 1000mm stumps included. Greater height = additional cost' },
  // WALL FRAME
  { id:'wf1', cat:'Structural', name:'Additional 900mm Ã— 900mm shower to existing wet area (ground floor)', price:2555, note:'Includes framed screen, floor/wall tiles. Single storey only' },
  { id:'wf2', cat:'Structural', name:'Additional ensuite 1710mm Ã— 2700mm adjacent to bedroom', price:6800, note:'Includes plasterboard, cavity sliding door, framed screen, toilet, vanity (900mm), tapware, tiles' },
  // CEILING HEIGHT
  { id:'c1', cat:'Ceiling Height', name:'2550mm nominal ceiling height (single storey / ground floor)', price:4080, note:'Includes painted fibre cement sheet infill over windows and doors' },
  { id:'c2', cat:'Ceiling Height', name:'2700mm nominal ceiling height (single storey / ground floor)', price:6980, note:'Includes painted fibre cement sheet infill over windows and doors' },
  // ROOFING
  { id:'r1', cat:'Roofing', name:'Heavy duty foil backed sisalation beneath tiled roof', price:2550, note:'Tiled roof only' },
  { id:'r2', cat:'Roofing', name:'Colorbond sheet metal roofing in lieu of standard tiles', price:0, note:'Nil cost variation' },
  { id:'r3', cat:'Roofing', name:'60mm (anticon) foil backed insulation blanket beneath sheet roof', price:1940, note:'Sheet roof only' },
  { id:'r4', cat:'Roofing', name:'Colorbond rotary roof ventilator + 2 eave vents (tiled roof)', price:535, note:'' },
  { id:'r5', cat:'Roofing', name:'Colorbond rotary roof ventilator + 2 eave vents (Colorbond roof)', price:714, note:'' },
  // WINDOWS & SLIDING DOORS
  { id:'w1', cat:'Windows & Doors', name:'Aluminium stacker door â€” 2 sliding + 1 fixed panel to Alfresco', price:1040, note:'Up to 2100H Ã— 2400W. Replaces standard sliding door' },
  { id:'w2', cat:'Windows & Doors', name:'700mm high aluminium fixed clear toughened glass window to kitchen back bench', price:1010, note:'Extended benchtop (no bottom reveal). Excludes window covering' },
  { id:'w3', cat:'Windows & Doors', name:'2100 Ã— 2100mm aluminium bi-fold door to Alfresco', price:4060, note:'Replaces 2100 Ã— 2100 sliding door. Deletes insect screens. Includes window covering' },
  { id:'w4', cat:'Windows & Doors', name:'2100 Ã— 2400mm aluminium bi-fold door to Alfresco', price:4100, note:'Replaces 2100 Ã— 2400 sliding door. Deletes insect screens. Includes window covering' },
  // ENTRANCE DOOR
  { id:'e1', cat:'Entrance Door', name:'2040 Ã— 1200mm Hume Newington XN5 hinged front entry door (paint finish)', price:1220, note:'Replaces standard entry door' },
  { id:'e2', cat:'Entrance Door', name:'2040 Ã— 1200mm Hume Newington XN5 SPM hinged entry door (stain finish + translucent glazing)', price:2010, note:'Includes stain finish entry door frame' },
  { id:'e3', cat:'Entrance Door', name:'2040 Ã— 920mm Hume Newington XN5 hinged entry door (paint + translucent glazing)', price:310, note:'' },
  { id:'e4', cat:'Entrance Door', name:'Gainsborough Freestyle Smart Wi-Fi Trilock entrance set', price:410, note:'In lieu of standard leverset' },
  // GARAGE DOOR
  { id:'g1', cat:'Garage Door', name:'2100H Ã— 4800W Caoba "Timber Look" Colorbond sectional garage door (slimline panels)', price:530, note:'In lieu of standard garage door' },
  // WARDROBE DOORS
  { id:'wd1', cat:'Wardrobe Doors', name:'Aluminium framed sliding wardrobe doors with mirror inserts (per wardrobe)', price:140, note:'Builders standard range. Price per wardrobe' },
  // SHELVING
  { id:'sh1', cat:'Shelving', name:'White melamine shelving to all bedroom wardrobes, linen & broom cupboards', price:1150, note:'Single shelf + hanging rail to wardrobes, 4 shelves to linen, 1 shelf to broom' },
  { id:'sh2', cat:'Shelving', name:'500mm white melamine unit â€” 4 drawers + 2 open shelves (per unit)', price:680, note:'Includes upgrade of existing single shelf to white melamine. Price per unit' },
  // CABINETRY
  { id:'cab1', cat:'Cabinetry', name:'Handle-less cabinetry throughout (excluding pantry)', price:610, note:'Pantry doors get Kethy DL213P edge pull handles due to door configuration' },
  { id:'cab2', cat:'Cabinetry', name:'Fully adjustable soft-close hinges & drawer runners throughout', price:650, note:'Excludes white melamine drawer units to wardrobes' },
  { id:'cab3', cat:'Cabinetry', name:'Single bank of 3 pot drawers (per unit)', price:440, note:'In lieu of standard floor cabinet. Price per unit' },
  { id:'cab4', cat:'Cabinetry', name:'800mm wide laminate floor cabinet to laundry', price:930, note:'Includes 20mm engineered stone benchtop, Posh Solus 45L sink, laminate doors' },
  { id:'cab5', cat:'Cabinetry', name:'Microwave provision to kitchen â€” pot drawer + single power point', price:510, note:'In lieu of standard cupboard door' },
  { id:'cab6', cat:'Cabinetry', name:'450mm drawer with Hafele One2Five Twin 32L bin system to kitchen', price:860, note:'In lieu of standard drawer' },
  // BENCHTOPS
  { id:'bt1', cat:'Benchtops', name:'20mm engineered stone benchtops to all floor cabinets throughout', price:1720, note:'In lieu of standard laminate. Builders standard range' },
  { id:'bt2', cat:'Benchtops', name:'20mm engineered stone "waterfall" gable end to kitchen island (per end)', price:710, note:'Price per end' },
  { id:'bt3', cat:'Benchtops', name:'40mm arris edge to 20mm engineered stone benchtops â€” kitchen', price:1240, note:'In lieu of 20mm engineered stone benchtops' },
  { id:'bt4', cat:'Benchtops', name:'40mm arris edge to 20mm engineered stone â€” bathroom & ensuite (2 vanities)', price:230, note:'' },
  { id:'bt5', cat:'Benchtops', name:'40mm "waterfall" gable end to kitchen island (per end)', price:1020, note:'Benchtops must be upgraded to 40mm to accommodate. Price per end' },
  // TILING WALLS
  { id:'tw1', cat:'Tiling Walls', name:'Floor-to-ceiling tiling â€” bathroom & ensuite (2440mm ceiling)', price:3090, note:'' },
  { id:'tw2', cat:'Tiling Walls', name:'Floor-to-ceiling tiling â€” bathroom & ensuite (2590mm ceiling)', price:3320, note:'' },
  { id:'tw3', cat:'Tiling Walls', name:'Floor-to-ceiling tiling â€” bathroom & ensuite (2740mm ceiling)', price:3550, note:'' },
  { id:'tw4', cat:'Tiling Walls', name:'600 Ã— 300mm cushioned edge ceramic wall tiles â€” Range 1 throughout', price:720, note:'Laid to standard nominal heights. Same colour as selected scheme' },
  { id:'tw5', cat:'Tiling Walls', name:'600 Ã— 300mm rectified edge porcelain wall tiles â€” Range 2 throughout', price:985, note:'Laid to standard nominal heights' },
  { id:'tw6', cat:'Tiling Walls', name:'400H Ã— 600W feature tiled wall niche/recess to shower (per niche)', price:340, note:'Price per niche' },
  // SHOWER SCREENS
  { id:'ss1', cat:'Shower Screens', name:'Semi-frameless shower screen with overlap pivot door (per screen)', price:150, note:'' },
  { id:'ss2', cat:'Shower Screens', name:'Fully frameless shower screen with in-line pivot door (per screen)', price:1550, note:'' },
  // MIRRORS
  { id:'m1', cat:'Mirrors', name:'900mm high frameless polished edge mirrors over width of vanity (per mirror)', price:140, note:'' },
  // PLUMBING HARDWARE
  { id:'ph1', cat:'Plumbing Hardware', name:'Mizu Soothe square gooseneck sink mixer to kitchen', price:150, note:'In lieu of standard' },
  { id:'ph2', cat:'Plumbing Hardware', name:'Mizu Soothe mixer tapware throughout (excl. kitchen)', price:660, note:'Includes Zenith 320mm wall mounted swivel spout to laundry tub' },
  { id:'ph3', cat:'Plumbing Hardware', name:'Cold water point (chrome mini cistern tap) to fridge space', price:160, note:'For owner\u2019s future appliance connection' },
  { id:'ph4', cat:'Plumbing Hardware', name:'Memo Hugo double bowl undermount sink (no taphole) to kitchen', price:780, note:'Includes polished edges, benchtop cut-out, tapware relocation to benchtop' },
  { id:'ph5', cat:'Plumbing Hardware', name:'Base 1500mm freestanding bath', price:1210, note:'' },
  { id:'ph6', cat:'Plumbing Hardware', name:'Double vanity unit (up to 1800mm wide)', price:1995, note:'Includes floor cabinetry, 2nd basin, tapware, mirror, tiled splashback' },
  { id:'ph7', cat:'Plumbing Hardware', name:'Posh Domaine twin rail shower with top rail water inlet (per rail)', price:280, note:'In lieu of standard shower rail' },
  // APPLIANCES
  { id:'ap1', cat:'Appliances', name:'900mm Technika electric appliances (oven + cooktop + rangehood)', price:1310, note:'Bellissimo TB90FSS-5 oven, Venini GECE9004 cooktop, GDA GEH9017 rangehood' },
  { id:'ap2', cat:'Appliances', name:'900mm Technika appliances with gas cooktop (oven + gas cooktop + rangehood)', price:2490, note:'Bellissimo TB95GWFSS-3 gas cooktop, TB90FSS-5 oven, GEH9017 externally ducted rangehood. Natural gas or LPG' },
  { id:'ap3', cat:'Appliances', name:'900mm Technika dual fuel freestanding stove + rangehood', price:2570, note:'GHE09TDSS-4 stove, GEH9017 rangehood. Natural gas or LPG' },
  { id:'ap4', cat:'Appliances', name:'600mm Technika HNTB64GWS gas cooktop', price:1190, note:'Natural gas or LPG. Gas service laid throughout house to external wall' },
  // HOT WATER
  { id:'hw1', cat:'Hot Water System', name:'26 litre instantaneous gas hot water unit', price:1500, note:'Includes gas connection from mains. Natural gas or LPG' },
  // ELECTRICAL - LIGHTING
  { id:'el1', cat:'Electrical â€“ Lighting', name:'Additional LED downlight (per downlight)', price:110, note:"Builder's standard range. Price per downlight" },
  { id:'el2', cat:'Electrical â€“ Lighting', name:'Beacon Marcel clear/black feature pendant light (per light)', price:420, note:'011036 model. 25W LED globe. Customer to nominate location before plans lodged' },
  { id:'el3', cat:'Electrical â€“ Lighting', name:'Mercator Eliza stainless steel up/down wall light (per light)', price:200, note:'MXD4132SS. 2 Ã— 6W LED. Customer to nominate location before plans lodged' },
  { id:'el4', cat:'Electrical â€“ Lighting', name:'LED strip light to cabinetry (per metre)', price:170, note:'' },
  // ELECTRICAL - FANS
  { id:'ef1', cat:'Electrical â€“ Fans', name:'Essentials Range 48" ceiling fan + 2 LED downlights (all rooms with fan/light combo)', price:540, note:'Replaces fan/light combination in all applicable rooms' },
  { id:'ef2', cat:'Electrical â€“ Fans', name:'Additional Essentials Range 48" white ceiling fan (per fan)', price:320, note:'Customer to nominate location before plans lodged' },
  { id:'ef3', cat:'Electrical â€“ Fans', name:'Additional Essentials Range 48" ceiling fan/light combination (per fan)', price:350, note:'Customer to nominate location before plans lodged' },
  { id:'ef4', cat:'Electrical â€“ Fans', name:'Exhaust fan/light combination (ducted externally) â€” ensuite & bathroom (total 2)', price:810, note:'Circular white. In lieu of standard downlight' },
  { id:'ef5', cat:'Electrical â€“ Fans', name:'Exhaust fan/light/dual heat lamp (ducted externally) â€” ensuite & bathroom (total 2)', price:800, note:'Square white. In lieu of standard downlight' },
  // ELECTRICAL - POWER
  { id:'ep1', cat:'Electrical â€“ Power', name:'Additional 10amp single power point (per point)', price:75, note:'Customer to nominate location before plans lodged' },
  { id:'ep2', cat:'Electrical â€“ Power', name:'Additional 10amp double power point (per point)', price:85, note:'Customer to nominate location before plans lodged' },
  { id:'ep3', cat:'Electrical â€“ Power', name:'Additional 10amp double power point with dual USB charging (per point)', price:180, note:'Customer to nominate location before plans lodged' },
  { id:'ep4', cat:'Electrical â€“ Power', name:'Additional 10amp weatherproof double power point (per point)', price:135, note:'Customer to nominate location before plans lodged' },
  // ELECTRICAL - OTHER
  { id:'eo1', cat:'Electrical â€“ Other', name:'Additional TV connection point (per point)', price:95, note:'Customer to nominate location before plans lodged' },
  { id:'eo2', cat:'Electrical â€“ Other', name:'Additional Cat6 phone/data connection point (per point)', price:135, note:'Customer to nominate location before plans lodged' },
  { id:'eo3', cat:'Electrical â€“ Other', name:'Three phase underground power connection (in lieu of standard single phase)', price:1020, note:'' },
  // TIMBER FLOORING
  { id:'tf1', cat:'Timber Flooring', name:'Wood Effects "Essentials" laminate floor â€” single storey main floor areas', price:1150, note:'Includes moisture repelling underlay. Excludes wet areas' },
  { id:'tf2', cat:'Timber Flooring', name:'Wood Effects "Essentials" laminate floor â€” single storey bedroom areas', price:3070, note:'In addition to main floor laminate. Excludes levelling compound' },
  { id:'tf3', cat:'Timber Flooring', name:'Wood Effects Plus 6.5mm hybrid floor â€” single storey main floor areas', price:2360, note:'Excludes wet areas' },
  { id:'tf4', cat:'Timber Flooring', name:'Wood Effects Plus 6.5mm hybrid floor â€” single storey bedroom areas', price:4180, note:'In addition to main floor hybrid. Excludes levelling compound' },
  // CARPET
  { id:'cp1', cat:'Carpet', name:'"Cordova" upgrade range carpet with 10mm foam underlay', price:280, note:'To all untiled and non-timber floor areas throughout' },
  // FLOOR TILES
  { id:'ft1', cat:'Floor Tiles', name:'600 Ã— 600mm cushioned edge ceramic floor tiles Range 1 â€” main living areas', price:1720, note:'Excludes wet areas. Tiles from selected colour scheme' },
  { id:'ft2', cat:'Floor Tiles', name:'600 Ã— 600mm cushioned edge ceramic floor tiles Range 1 â€” all wet areas', price:1520, note:'Includes tile insert strip drain waste to shower compartments' },
  { id:'ft3', cat:'Floor Tiles', name:'600 Ã— 600mm rectified edge porcelain floor tiles Range 2 â€” main living areas', price:3870, note:'Standard wall tiles retained. Excludes wet areas' },
  { id:'ft4', cat:'Floor Tiles', name:'600 Ã— 600mm rectified edge porcelain floor tiles Range 2 â€” all wet areas', price:2140, note:'Includes tile insert strip drain waste' },
  { id:'ft5', cat:'Floor Tiles', name:'450 Ã— 450mm cushioned edge ceramic floor tiles Range 1 â€” bedrooms', price:2260, note:'In lieu of standard carpet' },
  { id:'ft6', cat:'Floor Tiles', name:'600 Ã— 600mm rectified edge porcelain floor tiles Range 1 â€” bedrooms', price:6070, note:'In lieu of standard carpet' },
  // AIR CONDITIONING
  { id:'ac1', cat:'Air Conditioning', name:'Reverse cycle inverter split system A/C â€” bedroom (per unit)', price:2230, note:'Includes separate electrical circuit and isolator' },
  { id:'ac2', cat:'Air Conditioning', name:'Reverse cycle inverter split system A/C â€” living area (per unit)', price:3235, note:'Includes separate electrical circuit and isolator' },
  { id:'ac3', cat:'Air Conditioning', name:'Reverse cycle ducted A/C system in lieu of standard split units (3 zones)', price:7840, note:'House specific outlets. Includes 3 zones' },
  { id:'ac4', cat:'Air Conditioning', name:'Reverse cycle ducted A/C system (up to 5 zones)', price:13300, note:'House specific outlets. Includes up to 5 zones' },
  { id:'ac5', cat:'Air Conditioning', name:'Air Touch 5 Wi-Fi zone & temperature controller upgrade for ducted A/C', price:2640, note:'Additional costs if more than 6 zones required' },
  // SCREENS
  { id:'sc1', cat:'Screens', name:'Aluminium framed barrier screen â€” 2100H Ã— 820W hinged door (per screen)', price:330, note:'Diamond shaped grills, black finish, single keyed lock' },
  { id:'sc2', cat:'Screens', name:'Aluminium framed barrier screens to all windows & sliding doors', price:1300, note:'Diamond shaped grills, black finish. Excludes external hinged door openings' },
  // WINDOW COVERINGS
  { id:'wc1', cat:'Window Coverings', name:'Roller blind coverings to all windows & sliding glass doors', price:810, note:'Excludes wet areas and kitchen back bench window' },
  { id:'wc2', cat:'Window Coverings', name:'No window coverings (owner to supply & install after handover)', price:-1130, note:'Credit â€” removes standard vertical blinds' },
  // DRIVEWAY & PATH
  { id:'dp1', cat:'Driveway & Path', name:'2400 Ã— 1400mm exposed aggregate reinforced concrete clothesline pad', price:590, note:'Colour from Essentials Range, must match driveway' },
  // ALFRESCO
  { id:'al1', cat:'Alfresco', name:'Unsealed exposed aggregate reinforced concrete to Alfresco', price:195, note:'Colour from Essentials Range' },
  { id:'al2', cat:'Alfresco', name:'Exterior grade floor tiles (Range 1) to porch & alfresco', price:1675, note:'Fixed directly over concrete slab' },
  { id:'al3', cat:'Alfresco', name:'Hardwood decking on treated pine subfloor up to 1000mm high (per mÂ²)', price:367, note:'Includes adjustable steel support stumps. Price per mÂ²' },
];

const CATALOGUE_CATS = ['All', ...new Set(CATALOGUE.map(i => i.cat))];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LAND = 465000, BUILD = 380700, TOTAL = 845700;

const DEFAULT_STAGES = [
  { id:1, name:'Deposit / Contract', icon:'ğŸ“', desc:'Initial deposit on signing the building contract', pct:5, fixed:null },
  { id:2, name:'Land Settlement', icon:'ğŸ›ï¸', desc:'Full land payment due at settlement', pct:null, fixed:465000 },
  { id:3, name:'Base / Slab', icon:'ğŸª¨', desc:'Payment on completion of engineered slab/foundation', pct:10, fixed:null },
  { id:4, name:'Frame', icon:'ğŸ—ï¸', desc:'Payment on completion of wall and roof frame', pct:15, fixed:null },
  { id:5, name:'Lock-Up', icon:'ğŸ”’', desc:'Payment when home is weatherproof & lockable', pct:35, fixed:null },
  { id:6, name:'Fixing / Fitout', icon:'ğŸ”§', desc:'Payment on internal fixing stage completion', pct:25, fixed:null },
  { id:7, name:'Practical Completion', icon:'ğŸ ', desc:'Final payment on handover of keys', pct:10, fixed:null },
];

const DEFAULT_MILESTONES = [
  'Contract Signed','Finance Approved','Land Registration','Land Settlement',
  'Construction Start','Slab Poured','Frame Up','Lock Up',
  'Fixings Complete','Practical Completion / Handover','First Move-in'
].map((label,i) => ({ id:i+1, label, done:false, date:'' }));

const DEFAULT_ONCOSTS = [
  { id:'stamp', name:'Stamp Duty (QLD)', amount:0, note:'First home buyers may be eligible for concession â€” check with solicitor' },
  { id:'conv', name:'Conveyancing / Legal Fees', amount:2500, note:'Estimated' },
  { id:'loan', name:'Loan Establishment Fees', amount:800, note:'Varies by lender' },
  { id:'insp', name:'Building Inspections (all stages)', amount:1200, note:'Recommended at each progress stage' },
  { id:'util', name:'Utility Connections', amount:1500, note:'Power, water, gas' },
  { id:'lmi', name:'Lenders Mortgage Insurance (LMI)', amount:0, note:'If deposit < 20% â€” check with lender' },
  { id:'move', name:'Moving / Relocation Costs', amount:1500, note:'Estimated' },
  { id:'misc', name:'Miscellaneous / Contingency (3â€“5%)', amount:3000, note:'Recommended buffer' },
];

function loadState() {
  try {
    const s = localStorage.getItem('lot59_v3');
    if (s) return JSON.parse(s);
  } catch(e){}
  return {
    stages: DEFAULT_STAGES.map(s => ({ ...s, paid:false, paidDate:'', dueDate:'', note:'', customAmount:null, splits:[], isCustom:false })),
    milestones: JSON.parse(JSON.stringify(DEFAULT_MILESTONES)),
    oncosts: JSON.parse(JSON.stringify(DEFAULT_ONCOSTS)),
    // catalogue selections: { catId: status } â€” 'included'/'pending'/'excluded'
    catSelections: {},
    // custom variations added by user
    customVars: [
      { id:Date.now(), name:'Free Upgrade Promo Pack', cat:'Promo Upgrade', amount:7140, status:'included', date:'2026-02-28', note:'Signed before 28 Feb 2026 â€” gas cooktop, semi-frameless screens, pendant lights, handleless cabinetry, waterfall benchtop, double sink, soft-close drawers, mirrors, cold water point' }
    ],
    notes:[],
  };
}

let state = loadState();
// Migrate: ensure all stages have splits and isCustom fields
state.stages.forEach(s => { if(!s.splits) s.splits=[]; if(s.isCustom===undefined) s.isCustom=false; });
let currentTab = 'overview';
let currentVarTab = 'catalogue';
let catFilter = 'All';
let catSearch = '';
let editingCustomId = null;
let saveTimer = null;

function save() {
  localStorage.setItem('lot59_v3', JSON.stringify(state));
  const el = document.getElementById('saveInd');
  el.classList.add('show');
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => el.classList.remove('show'), 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = n => new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD',maximumFractionDigits:0}).format(n||0);
function fmtDate(d) {
  if (!d) return 'â€”';
  const [y,m,dd] = d.split('-');
  return new Date(+y,+m-1,+dd).toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'});
}
function stageAmt(s) {
  if (s.fixed !== null) return s.fixed;
  return s.customAmount !== null ? s.customAmount : Math.round(s.pct/100*BUILD);
}

// All variations = catalogue selected + custom
function allVariations() {
  const fromCat = CATALOGUE
    .filter(c => state.catSelections[c.id])
    .map(c => ({ id:'cat_'+c.id, name:c.name, cat:c.cat, amount:c.price, status:state.catSelections[c.id], note:c.note, fromCatalogue:true }));
  return [...state.customVars, ...fromCat];
}

function varTotals() {
  const all = allVariations();
  return {
    inc: all.filter(v=>v.status==='included').reduce((a,v)=>a+(parseFloat(v.amount)||0),0),
    pend: all.filter(v=>v.status==='pending').reduce((a,v)=>a+(parseFloat(v.amount)||0),0),
    exc: all.filter(v=>v.status==='excluded').reduce((a,v)=>a+(parseFloat(v.amount)||0),0),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, el) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
  if(el) el.classList.add('active');
  document.getElementById('tab-'+name).style.display = '';
  currentTab = name;
  render();
}

function setVarTab(name) {
  currentVarTab = name;
  ['catalogue','mylist','custom'].forEach(t => {
    document.getElementById('vsub-'+t).style.display = t===name ? '' : 'none';
    document.getElementById('vtab-'+t).classList.toggle('active', t===name);
  });
  if (name==='catalogue') renderCatalogue();
  if (name==='mylist') renderMyList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  updateProgress();
  if (currentTab==='overview') renderOverview();
  if (currentTab==='payments') renderPayments();
  if (currentTab==='variations') { renderVarSummary(); if(currentVarTab==='catalogue') renderCatalogue(); else if(currentVarTab==='mylist') renderMyList(); }
  if (currentTab==='timeline') renderTimeline();
  if (currentTab==='costs') renderCosts();
  if (currentTab==='notes') renderNotes();
}

function updateProgress() {
  const done = state.milestones.filter(m=>m.done).length;
  const pct = Math.round(done/state.milestones.length*100);
  document.getElementById('progLabel').textContent = pct+'% milestones complete';
  document.getElementById('progFill').style.width = pct+'%';
}

function renderOverview() {
  const paid = state.stages.filter(s=>s.paid).reduce((a,s)=>a+stageAmt(s),0);
  const total = state.stages.reduce((a,s)=>a+stageAmt(s),0);
  const vt = varTotals();
  const onc = state.oncosts.reduce((a,c)=>a+(parseFloat(c.amount)||0),0);
  document.getElementById('sumCards').innerHTML = [
    {label:'Total Paid',value:fmt(paid),sub:`${Math.round(paid/total*100)||0}% of schedule`,color:'var(--teal)'},
    {label:'Remaining',value:fmt(total-paid),sub:'on payment schedule',color:'var(--red)'},
    {label:'Land',value:fmt(LAND),sub:'394mÂ² Holmview',color:'var(--gold)'},
    {label:'Build Contract',value:fmt(BUILD),sub:'Custom 155',color:'var(--gold)'},
    {label:'Confirmed Variations',value:fmt(vt.inc),sub:`${allVariations().filter(v=>v.status==='included').length} items`,color:'var(--green)'},
    {label:'Est. Grand Total',value:fmt(TOTAL+vt.inc+onc),sub:'incl. all oncosts',color:'var(--gold2)'},
  ].map(c=>`<div class="sum-card"><div class="sum-lbl">${c.label}</div><div class="sum-val" style="color:${c.color}">${c.value}</div><div class="sum-sub">${c.sub}</div></div>`).join('');
}

function renderPayments() {
  let totalPaidAmt = 0, totalSchedAmt = 0;
  state.stages.forEach(s => {
    const amt = stageAmt(s);
    totalSchedAmt += amt;
    if (s.splits && s.splits.length > 0) {
      totalPaidAmt += s.splits.filter(sp=>sp.paid).reduce((a,sp)=>a+(parseFloat(sp.amount)||0),0);
    } else if (s.paid) {
      totalPaidAmt += amt;
    }
  });
  const pct = totalSchedAmt > 0 ? totalPaidAmt/totalSchedAmt*100 : 0;
  document.getElementById('payPaid').textContent = fmt(totalPaidAmt);
  document.getElementById('payRem').textContent = fmt(totalSchedAmt - totalPaidAmt);
  document.getElementById('payBar').style.width = pct+'%';
  const fullyPaid = state.stages.filter(s => {
    if (s.splits && s.splits.length > 0) return s.splits.every(sp=>sp.paid);
    return s.paid;
  }).length;
  document.getElementById('stageCount').textContent = fullyPaid + ' of ' + state.stages.length + ' paid';
  document.getElementById('stageTot').textContent = fmt(totalSchedAmt);
  const today = new Date().toISOString().split('T')[0];

  let html = '';
  state.stages.forEach(s => {
    const amt = stageAmt(s);
    const hasSplits = s.splits && s.splits.length > 0;
    const splitPaid = hasSplits ? s.splits.filter(sp=>sp.paid).reduce((a,sp)=>a+(parseFloat(sp.amount)||0),0) : 0;
    const splitTotal = hasSplits ? s.splits.reduce((a,sp)=>a+(parseFloat(sp.amount)||0),0) : 0;
    const effectivelyPaid = hasSplits ? s.splits.every(sp=>sp.paid) : s.paid;
    const overdue = s.dueDate && !effectivelyPaid && s.dueDate < today;
    const splitCount = hasSplits ? s.splits.filter(sp=>sp.paid).length + '/' + s.splits.length : '';

    let splitsHtml = '';
    if (hasSplits) {
      let splitItems = '';
      s.splits.forEach((sp, i) => {
        const spOverdue = sp.dueDate && !sp.paid && sp.dueDate < today;
        splitItems += '<div style="background:var(--bg);border:1px solid ' + (sp.paid ? '#1E3B36' : (spOverdue ? '#2E1A0F' : 'var(--border)')) + ';border-radius:6px;padding:.7rem .9rem;margin-bottom:.5rem;">'
          + '<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem;">'
          + '<div style="flex:1;">'
          + '<input type="text" value="' + (sp.label||'') + '" placeholder="Label e.g. First instalment" onchange="updateSplit(' + s.id + ',' + i + ',\'label\',this.value)" style="width:100%;font-size:.82rem;margin-bottom:.4rem;">'
          + '<div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">'
          + '<label style="display:flex;align-items:center;gap:.35rem;cursor:pointer;font-size:.76rem;color:var(--muted);"><input type="checkbox" ' + (sp.paid?'checked':'') + ' onchange="updateSplit(' + s.id + ',' + i + ',\'paid\',this.checked)" style="accent-color:var(--teal);"> Paid</label>'
          + (sp.paid ? '<input type="date" value="' + (sp.paidDate||'') + '" onchange="updateSplit(' + s.id + ',' + i + ',\'paidDate\',this.value)" style="color:var(--teal);font-size:.72rem;" title="Date paid">' : '')
          + '<span style="font-size:.7rem;color:var(--dim);">Due:</span><input type="date" value="' + (sp.dueDate||'') + '" onchange="updateSplit(' + s.id + ',' + i + ',\'dueDate\',this.value)" style="font-size:.72rem;">'
          + (spOverdue ? '<span style="font-size:.68rem;color:var(--red);">OVERDUE</span>' : '')
          + '</div></div>'
          + '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:.4rem;">'
          + '<input type="number" value="' + (sp.amount||0) + '" onchange="updateSplit(' + s.id + ',' + i + ',\'amount\',this.value)" style="width:110px;text-align:right;font-size:.9rem;color:' + (sp.paid?'var(--teal)':'var(--gold)') + ';font-weight:bold;">'
          + '<button onclick="deleteSplit(' + s.id + ',' + i + ')" style="background:transparent;border:1px solid var(--red);color:var(--red);border-radius:4px;padding:.18rem .5rem;cursor:pointer;font-size:.7rem;font-family:inherit;">âœ• Remove</button>'
          + '</div></div></div>';
      });
      const mismatch = splitTotal !== amt ? ' <span style="color:var(--red);font-size:.68rem;">(splits total differs from stage amount!)</span>' : '';
      splitsHtml = '<div style="margin-top:.8rem;border-top:1px solid var(--border);padding-top:.8rem;">'
        + '<div style="font-size:.7rem;color:#A78BFA;letter-spacing:.1em;text-transform:uppercase;margin-bottom:.6rem;">âœ‚ Split Payments</div>'
        + splitItems
        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:.3rem;">'
        + '<button onclick="addSplit(' + s.id + ')" style="background:var(--bg3);border:1px solid #2A2A50;color:#A78BFA;border-radius:5px;padding:.3rem .8rem;cursor:pointer;font-size:.74rem;font-family:inherit;">+ Add Split</button>'
        + '<div style="font-size:.78rem;color:var(--muted);">Paid <span style="color:var(--teal);font-weight:bold;">' + fmt(splitPaid) + '</span> of <span style="color:var(--gold);">' + fmt(splitTotal) + '</span>' + mismatch + '</div>'
        + '</div></div>';
    }

    const nameField = s.isCustom
      ? '<input type="text" value="' + s.name.replace(/"/g,'&quot;') + '" onchange="updateStageF(' + s.id + ',\'name\',this.value)" style="font-size:.92rem;font-weight:bold;color:' + (effectivelyPaid?'var(--teal)':'var(--text)') + ';background:transparent;border:none;border-bottom:1px dashed var(--border2);padding:0;max-width:220px;">'
      : s.name;

    const amtField = (s.fixed !== null && !s.isCustom)
      ? '<div style="font-size:1rem;font-weight:bold;color:var(--gold);">' + fmt(amt) + '</div>'
      : '<input type="number" value="' + amt + '" onchange="updateStageAmt(' + s.id + ',this.value)" style="width:120px;text-align:right;font-size:.95rem;color:var(--gold);font-weight:bold;">'
        + (!s.isCustom ? '<div style="font-size:.67rem;color:var(--dim);margin-top:.15rem;">~' + s.pct + '% of build</div>' : '');

    const singlePaidCtrl = !hasSplits ? (
      '<div class="stage-ctrls">'
      + '<label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;font-size:.78rem;color:var(--muted);"><input type="checkbox" ' + (s.paid?'checked':'') + ' onchange="togglePaid(' + s.id + ',this.checked)"> Mark as paid</label>'
      + '<div style="display:flex;align-items:center;gap:.35rem;"><span style="font-size:.7rem;color:var(--dim);">Due:</span><input type="date" value="' + (s.dueDate||'') + '" onchange="updateStageF(' + s.id + ',\'dueDate\',this.value)"></div>'
      + (s.paid ? '<div style="display:flex;align-items:center;gap:.35rem;"><span style="font-size:.7rem;color:var(--dim);">Paid on:</span><input type="date" value="' + (s.paidDate||'') + '" onchange="updateStageF(' + s.id + ',\'paidDate\',this.value)" style="color:var(--teal);"></div>' : '')
      + '</div>'
    ) : '';

    const splitBadge = hasSplits ? '<span class="badge" style="color:#A78BFA;background:#1A0F2E;">âœ‚ ' + splitCount + ' splits</span>' : '';
    const paidBadge = effectivelyPaid ? '<span class="badge badge-paid">PAID</span>' : '';
    const overdueBadge = overdue ? '<span class="badge" style="color:var(--red);background:#2E0F0F">OVERDUE</span>' : '';

    const actionBtns = '<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.7rem;padding-top:.6rem;border-top:1px solid var(--border);">'
      + (!hasSplits
          ? '<button onclick="splitStage(' + s.id + ')" style="background:var(--bg3);border:1px solid #2A2A50;color:#A78BFA;border-radius:5px;padding:.3rem .8rem;cursor:pointer;font-size:.74rem;font-family:inherit;">âœ‚ Split Payment</button>'
          : '<button onclick="unsplitStage(' + s.id + ')" style="background:var(--bg3);border:1px solid var(--border2);color:var(--muted);border-radius:5px;padding:.3rem .8rem;cursor:pointer;font-size:.74rem;font-family:inherit;">â†© Remove Splits</button>')
      + (s.isCustom ? '<button onclick="deleteStage(' + s.id + ')" style="background:transparent;border:1px solid var(--red);color:var(--red);border-radius:5px;padding:.3rem .8rem;cursor:pointer;font-size:.74rem;font-family:inherit;">ğŸ—‘ Delete Stage</button>' : '')
      + '</div>';

    html += '<div class="stage-item ' + (effectivelyPaid?'paid':'') + '" style="' + (hasSplits?'border-color:#2A2A50;':s.isCustom?'border-style:dashed;':'') + '">'
      + '<div class="stage-top">'
      + '<div class="stage-icon">' + (s.icon||'ğŸ’°') + '</div>'
      + '<div class="stage-body">'
      + '<div class="stage-title-row">'
      + '<div style="flex:1;"><div class="stage-name ' + (effectivelyPaid?'paid':'') + '">' + nameField + paidBadge + splitBadge + overdueBadge + '</div>'
      + '<div class="stage-desc">' + (s.isCustom?'Custom payment stage':s.desc) + '</div></div>'
      + '<div style="text-align:right;flex-shrink:0;">' + amtField + '</div>'
      + '</div>'
      + singlePaidCtrl
      + '<input class="stage-note" type="text" placeholder="Add a note..." value="' + (s.note||'').replace(/"/g,'&quot;') + '" onchange="updateStageF(' + s.id + ',\'note\',this.value)">'
      + splitsHtml
      + actionBtns
      + '</div></div></div>';
  });

  html += '<button onclick="addCustomStage()" style="width:100%;margin-top:.6rem;padding:.75rem;background:var(--bg2);border:1px dashed var(--border2);color:var(--gold);border-radius:8px;cursor:pointer;font-size:.82rem;font-family:inherit;">+ Add Custom Payment Stage</button>';

  document.getElementById('stagesList').innerHTML = html;
}

function renderVarSummary() {
  const vt = varTotals();
  document.getElementById('vIncTot').textContent = fmt(vt.inc);
  document.getElementById('vPendTot').textContent = fmt(vt.pend);
  document.getElementById('vExcTot').textContent = fmt(vt.exc);
  document.getElementById('vContractImpact').textContent = fmt(TOTAL+vt.inc);
}

function renderCatalogue() {
  // Build category filter tabs
  document.getElementById('catFilterTabs').innerHTML = CATALOGUE_CATS.map(c =>
    `<button class="var-tab ${catFilter===c?'active':''}" onclick="setCatFilter('${c}')">${c}</button>`
  ).join('');

  let items = CATALOGUE;
  if (catFilter !== 'All') items = items.filter(i => i.cat === catFilter);
  if (catSearch) items = items.filter(i => i.name.toLowerCase().includes(catSearch.toLowerCase()) || i.cat.toLowerCase().includes(catSearch.toLowerCase()));

  if (items.length === 0) {
    document.getElementById('catalogueList').innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>No variations match your search.</div></div>`;
    return;
  }

  const statusColors = {included:'var(--green)',pending:'var(--gold)',excluded:'var(--dim)'};
  const statusLabels = {included:'âœ“ Confirmed',pending:'â³ Pending',excluded:'âœ— Excluded'};

  document.getElementById('catalogueList').innerHTML = items.map(item => {
    const sel = state.catSelections[item.id];
    return `<div class="catalogue-item ${sel==='included'?'selected':sel==='pending'?'pending-sel':''}">
      <div class="cat-top">
        <input class="cat-check" type="checkbox" ${sel?'checked':''} onchange="toggleCatItem('${item.id}',this.checked)">
        <div class="cat-info">
          <div class="cat-name">${item.name}</div>
          ${item.note?`<div class="cat-note">${item.note}</div>`:''}
        </div>
        <div class="cat-right">
          <div class="cat-price ${sel==='included'?'selected':''}">${item.price===0?'$0 (no cost)':item.price<0?fmt(item.price)+' credit':fmt(item.price)}</div>
          ${sel?`<div class="cat-status" style="color:${statusColors[sel]}">${statusLabels[sel]}</div>`:''}
        </div>
      </div>
      ${sel?`<div style="margin-top:.6rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
        <select onchange="setCatStatus('${item.id}',this.value)" style="font-size:.75rem;">
          <option value="included" ${sel==='included'?'selected':''}>âœ“ Confirmed</option>
          <option value="pending" ${sel==='pending'?'selected':''}>â³ Pending</option>
          <option value="excluded" ${sel==='excluded'?'selected':''}>âœ— Excluded</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="removeCatItem('${item.id}')">Remove</button>
      </div>`:''}
    </div>`;
  }).join('');
}

function renderMyList() {
  const all = allVariations();
  if (all.length === 0) {
    document.getElementById('myVarList').innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>No variations added yet.</div><div style="margin-top:.4rem;font-size:.8rem;">Tick items in the Catalogue or add custom variations.</div></div>`;
    return;
  }
  const statusColors = {included:'var(--green)',pending:'var(--gold)',excluded:'var(--dim)'};
  const statusLabels = {included:'âœ“ Confirmed',pending:'â³ Pending',excluded:'âœ— Excluded'};
  document.getElementById('myVarList').innerHTML = all.map(v => `
    <div class="myvar-item ${v.status}">
      <div class="myvar-top">
        <div class="myvar-left">
          <div class="myvar-cat">${v.cat}${v.fromCatalogue?'<span style="margin-left:.5rem;color:var(--dim);font-weight:normal;">Â· from catalogue</span>':''}</div>
          <div class="myvar-name">${v.name}</div>
          ${v.note?`<div class="myvar-note">${v.note}</div>`:''}
          ${v.date?`<div class="myvar-note" style="color:var(--dim)">ğŸ“… ${fmtDate(v.date)}</div>`:''}
        </div>
        <div class="myvar-right">
          <div class="myvar-amt">${fmt(parseFloat(v.amount)||0)}</div>
          <div class="myvar-status-lbl" style="color:${statusColors[v.status]}">${statusLabels[v.status]}</div>
        </div>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
        ${v.fromCatalogue
          ? `<select onchange="setCatStatus('${v.id.replace('cat_','')}',this.value)" style="font-size:.75rem;">
              <option value="included" ${v.status==='included'?'selected':''}>âœ“ Confirmed</option>
              <option value="pending" ${v.status==='pending'?'selected':''}>â³ Pending</option>
              <option value="excluded" ${v.status==='excluded'?'selected':''}>âœ— Excluded</option>
             </select>
             <button class="btn btn-ghost btn-sm" onclick="removeCatItem('${v.id.replace('cat_','')}')">Remove</button>`
          : `<select onchange="updateCustomStatus(${v.id},this.value)" style="font-size:.75rem;">
              <option value="included" ${v.status==='included'?'selected':''}>âœ“ Confirmed</option>
              <option value="pending" ${v.status==='pending'?'selected':''}>â³ Pending</option>
              <option value="excluded" ${v.status==='excluded'?'selected':''}>âœ— Excluded</option>
             </select>
             <button class="btn btn-ghost btn-sm" onclick="editCustom(${v.id})">Edit</button>
             <button class="btn btn-red btn-sm" onclick="deleteCustom(${v.id})">Delete</button>`
        }
      </div>
    </div>`).join('');
}

function renderTimeline() {
  const done = state.milestones.filter(m=>m.done).length;
  document.getElementById('msCount').textContent = `${done}/${state.milestones.length} complete`;
  document.getElementById('msList').innerHTML = state.milestones.map((m,i) => `
    <div class="ms-item">
      <div class="ms-dot ${m.done?'done':''}" onclick="toggleMs(${m.id})">${m.done?'âœ“':i+1}</div>
      <div class="ms-card ${m.done?'done':''}">
        <div class="ms-row">
          <div class="ms-lbl ${m.done?'done':''}">${m.label}${m.done?'<span class="badge badge-done">DONE</span>':''}</div>
          <input type="date" value="${m.date||''}" onchange="updateMsDate(${m.id},this.value)" ${m.done?'style="color:var(--green)"':''}>
        </div>
        ${m.date?`<div style="font-size:.7rem;color:var(--dim);margin-top:.3rem;">ğŸ“… ${fmtDate(m.date)}</div>`:''}
      </div>
    </div>`).join('');
}

function renderCosts() {
  const incVars = allVariations().filter(v=>v.status==='included');
  const varTot = incVars.reduce((a,v)=>a+(parseFloat(v.amount)||0),0);
  const oncTot = state.oncosts.reduce((a,c)=>a+(parseFloat(c.amount)||0),0);
  document.getElementById('costsVarRows').innerHTML = incVars.length===0
    ? `<div class="card-row"><span style="color:var(--dim);font-size:.82rem">No confirmed variations yet</span></div>`
    : incVars.map(v=>`<div class="card-row"><div><span style="color:var(--text2);font-size:.86rem">${v.name}</span><span style="color:var(--dim);font-size:.72rem;margin-left:.5rem">(${v.cat})</span></div><span>${fmt(parseFloat(v.amount)||0)}</span></div>`).join('');
  document.getElementById('costsVarTot').textContent = fmt(varTot);
  document.getElementById('oncostRows').innerHTML = state.oncosts.map(c=>`
    <div class="card-row">
      <div><div style="color:var(--text2);font-size:.86rem">${c.name}</div><div style="color:var(--dim);font-size:.7rem">${c.note}</div></div>
      <input type="number" value="${c.amount||0}" onchange="updateOnc('${c.id}',this.value)" style="width:110px;text-align:right">
    </div>`).join('');
  document.getElementById('oncostTot').textContent = fmt(oncTot);
  document.getElementById('grandTot').textContent = fmt(TOTAL+varTot+oncTot);
}

function renderNotes() {
  if (!state.notes.length) {
    document.getElementById('notesList').innerHTML = `<div class="empty-state"><div class="empty-icon">âœï¸</div><div>No notes yet.</div><div style="margin-top:.4rem;font-size:.8rem">Record builder calls, decisions, inspection results.</div></div>`;
    return;
  }
  document.getElementById('notesList').innerHTML = state.notes.map(n=>`
    <div class="note-card">
      <div class="note-date">ğŸ“… ${fmtDate(n.date.split('T')[0])}</div>
      <div class="note-text">${n.text.replace(/</g,'&lt;')}</div>
      <div style="margin-top:.7rem"><button class="btn btn-red btn-sm" onclick="deleteNote(${n.id})">Delete</button></div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePaid(id,val) {
  const s=state.stages.find(x=>x.id===id); s.paid=val;
  if(val&&!s.paidDate) s.paidDate=new Date().toISOString().split('T')[0];
  save(); render();
}
function updateStageAmt(id,val) { state.stages.find(x=>x.id===id).customAmount=parseFloat(val)||0; save(); render(); }
function updateStageF(id,f,v) { state.stages.find(x=>x.id===id)[f]=v; save(); render(); }
function toggleMs(id) {
  const m=state.milestones.find(x=>x.id===id); m.done=!m.done;
  if(m.done&&!m.date) m.date=new Date().toISOString().split('T')[0];
  save(); render();
}
function updateMsDate(id,v) { state.milestones.find(x=>x.id===id).date=v; save(); render(); }
function updateOnc(id,v) { state.oncosts.find(x=>x.id===id).amount=parseFloat(v)||0; save(); render(); }

// Catalogue
function toggleCatItem(id,checked) {
  if(checked) state.catSelections[id]='pending';
  else delete state.catSelections[id];
  save(); renderCatalogue(); renderVarSummary();
}
function setCatStatus(id,val) { state.catSelections[id]=val; save(); renderCatalogue(); renderMyList(); renderVarSummary(); }
function removeCatItem(id) { delete state.catSelections[id]; save(); renderCatalogue(); renderMyList(); renderVarSummary(); }
function setCatFilter(f) { catFilter=f; renderCatalogue(); }
function filterCatalogue(v) { catSearch=v; renderCatalogue(); }

// Custom
function saveCustom() {
  const name=document.getElementById('cName').value.trim();
  const amount=parseFloat(document.getElementById('cAmount').value)||0;
  if(!name){alert('Please enter a description.');return;}
  if(editingCustomId){
    const v=state.customVars.find(x=>x.id===editingCustomId);
    v.name=name; v.cat=document.getElementById('cCat').value; v.amount=amount;
    v.status=document.getElementById('cStatus').value; v.date=document.getElementById('cDate').value;
    v.note=document.getElementById('cNote').value.trim();
    editingCustomId=null; document.getElementById('customFormTitle').textContent='New Custom Variation';
  } else {
    state.customVars.unshift({id:Date.now(),name,cat:document.getElementById('cCat').value,amount,
      status:document.getElementById('cStatus').value,date:document.getElementById('cDate').value,
      note:document.getElementById('cNote').value.trim()});
  }
  clearCustomForm(); save(); renderVarSummary(); alert('Saved! Go to My Variations to see it.');
}
function clearCustomForm() {
  ['cName','cAmount','cNote'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('cStatus').value='pending';
  editingCustomId=null; document.getElementById('customFormTitle').textContent='New Custom Variation';
}
function editCustom(id) {
  const v=state.customVars.find(x=>x.id===id);
  editingCustomId=id;
  document.getElementById('cName').value=v.name;
  document.getElementById('cCat').value=v.cat;
  document.getElementById('cAmount').value=v.amount;
  document.getElementById('cStatus').value=v.status;
  document.getElementById('cDate').value=v.date||'';
  document.getElementById('cNote').value=v.note||'';
  document.getElementById('customFormTitle').textContent='Edit Variation';
  setVarTab('custom');
}
function updateCustomStatus(id,val) { state.customVars.find(x=>x.id===id).status=val; save(); renderMyList(); renderVarSummary(); }
function deleteCustom(id) { if(!confirm('Delete this variation?')) return; state.customVars=state.customVars.filter(x=>x.id!==id); save(); renderMyList(); renderVarSummary(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPLIT & STAGE ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function splitStage(id) {
  const s = state.stages.find(x=>x.id===id);
  const amt = stageAmt(s);
  const half = Math.floor(amt/2);
  s.splits = [
    { label:'First instalment', amount:half, paid:false, paidDate:'', dueDate:'' },
    { label:'Second instalment', amount:amt-half, paid:false, paidDate:'', dueDate:'' },
  ];
  s.paid = false;
  save(); renderPayments();
}
function unsplitStage(id) {
  if (!confirm('Remove all splits and return to a single payment?')) return;
  const s = state.stages.find(x=>x.id===id);
  s.splits = []; s.paid = false;
  save(); renderPayments();
}
function addSplit(id) {
  const s = state.stages.find(x=>x.id===id);
  const used = s.splits.reduce((a,sp)=>a+(parseFloat(sp.amount)||0),0);
  const remaining = Math.max(0, stageAmt(s) - used);
  s.splits.push({ label:'Instalment '+(s.splits.length+1), amount:remaining, paid:false, paidDate:'', dueDate:'' });
  save(); renderPayments();
}
function deleteSplit(stageId, splitIdx) {
  const s = state.stages.find(x=>x.id===stageId);
  s.splits.splice(splitIdx, 1);
  save(); renderPayments();
}
function updateSplit(stageId, splitIdx, field, value) {
  const s = state.stages.find(x=>x.id===stageId);
  if (field === 'paid') {
    s.splits[splitIdx].paid = value;
    if (value && !s.splits[splitIdx].paidDate) s.splits[splitIdx].paidDate = new Date().toISOString().split('T')[0];
  } else if (field === 'amount') {
    s.splits[splitIdx].amount = parseFloat(value)||0;
  } else {
    s.splits[splitIdx][field] = value;
  }
  save(); renderPayments();
}
function addCustomStage() {
  state.stages.push({ id:Date.now(), name:'Custom Payment', icon:'ğŸ’°', desc:'', pct:null, fixed:null,
    paid:false, paidDate:'', dueDate:'', note:'', customAmount:0, splits:[], isCustom:true });
  save(); renderPayments();
}
function deleteStage(id) {
  if (!confirm('Delete this custom payment stage?')) return;
  state.stages = state.stages.filter(x=>x.id!==id);
  save(); renderPayments();
}

// Notes
function openNote() { document.getElementById('addNoteWrap').style.display=''; document.getElementById('noteText').focus(); }
function closeNote() { document.getElementById('addNoteWrap').style.display='none'; }
function saveNote() {
  const t=document.getElementById('noteText').value.trim();
  if(!t) return;
  state.notes.unshift({id:Date.now(),text:t,date:new Date().toISOString()});
  closeNote(); save(); render();
}
function deleteNote(id) { if(!confirm('Delete note?')) return; state.notes=state.notes.filter(n=>n.id!==id); save(); render(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('cDate').value = new Date().toISOString().split('T')[0];
render();
</script>
</body>
</html>
